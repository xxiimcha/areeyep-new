@model IEnumerable<dynamic> // Since we are selecting an anonymous type in the controller

@{
    Layout = null;  // Not using the _Layout.cshtml file for this specific page
    ViewData["Title"] = "Service Management";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>

    <!-- Include the CSS Links Partial -->
    @Html.Partial("_CSSLinks")

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="sb-nav-fixed">
    <!-- Render the Header Partial -->
    @Html.Partial("_Header")

    <div id="layoutSidenav">
        <!-- Render the Sidebar Partial -->
        @Html.Partial("_Sidebar")

        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid px-4">
                    <h1 class="mt-4">Service Requests</h1>
                    <ol class="breadcrumb mb-4">
                        <li class="breadcrumb-item active">Service Requests</li>
                    </ol>

                    <!-- Service Requests List Table -->
                    <div class="table-responsive">
                        <table id="serviceRequestsTable" class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Deceased Name</th>
                                    <th>Date of Service</th>
                                    <th>Service Type</th>
                                    <th>Urgency Level</th>
                                    <th>Status</th>
                                    <th>Staff</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Any())
                                {
                                    int i = 1;
                                    foreach (var request in Model)
                                    {
                                        <tr>
                                            <td>@i</td>
                                            <td>@request.DeceasedName</td>
                                            <td>@(request.DateOfService?.ToString("yyyy-MM-dd") ?? "N/A")</td>
                                            <td>@request.ServiceName</td>
                                            <td>@request.UrgencyLevel</td>
                                            <td>@request.Status</td>
                                            <td>@request.Staff</td>
                                            <td>
                                                <button class="btn btn-info btn-sm" onclick="viewRequest('@request.Id', '@request.DeceasedName', '@request.DateOfService', '@request.ServiceName', '@request.UrgencyLevel', '@request.Status', '@request.Staff')">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                            </td>
                                        </tr>
                                        i++;
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="8">No service requests found.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal for Viewing Service Request Details -->
    <div class="modal fade" id="viewRequestModal" tabindex="-1" aria-labelledby="viewRequestModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewRequestModalLabel">Service Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Deceased Name:</strong> <span id="modalDeceasedName"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Date of Service:</strong> <span id="modalDateOfService"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Service Type:</strong> <span id="modalServiceType"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Urgency Level:</strong> <span id="modalUrgencyLevel"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Status:</strong> <span id="modalStatus"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Staff:</strong> <span id="modalStaff"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Script Links Partial -->
    @Html.Partial("_ScriptLinks")

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Initialize DataTable and Custom Scripts -->
    <script>
        $(document).ready(function () {
            // Initialize DataTables for the service requests table
            $('#serviceRequestsTable').DataTable({
                "paging": true,
                "searching": true,
                "ordering": true,
                "info": true
            });
        });

        // Function to handle viewing a request
        function viewRequest(id, deceasedName, dateOfService, serviceName, urgencyLevel, status, staff) {
            // Populate the modal with the data from the row
            $('#modalDeceasedName').text(deceasedName);
            $('#modalDateOfService').text(dateOfService != "null" ? dateOfService : "N/A");
            $('#modalServiceType').text(serviceName);
            $('#modalUrgencyLevel').text(urgencyLevel);
            $('#modalStatus').text(status);
            $('#modalStaff').text(staff);

            // Show the modal
            var viewModal = new bootstrap.Modal(document.getElementById('viewRequestModal'));
            viewModal.show();
        }
    </script>
</body>
</html>
